Separated some part from dsp and controller.
